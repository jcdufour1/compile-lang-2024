io :: import = std.io

add_one :: fn(num i32*) {
    *num = num + 1
}

sub_one_explicit :: fn(num i32*) {
    *num = *num - 1
}

add_one_explicit :: fn(num i32*) {
    *num = *num + 1
}

operation_2 :: fn(num i32*) {
    *num = 2*num + 1
}

operation_2_explicit :: fn(num i32*) {
    *num = 2*num + 1
}

Div :: struct {
    numerator i32
    denominator i32
}

set_div :: fn(div Div*) {
    new_div Div := {.numerator = 134, .denominator = 45};
    *div = new_div;
}

set_div_denominator :: fn(div Div*) {
    div.denominator = 1298;
}

set_div_denominator_explicit_deref :: fn(div Div*) {
    (*div).denominator = 1234;
}

print_div :: fn(div Div*) {
    io.printf("%d/%d\n", div.numerator, div.denominator)
}

set_div_from_another :: fn(dest Div*, src Div*) {
    dest.denominator = src.denominator;
}

set_string :: fn(string u8**) {
    *string = "bye"
}

cast_to_pointer :: fn() {
    pointer u8* := unsafe_cast<u8*>0

    if pointer == unsafe_cast<u8*>0 {
        io.printf("yes\n");
    }

    if pointer == unsafe_cast<u8*>1 {
        io.printf("no\n");
    }

    zero i64 := unsafe_cast<i64>pointer
    io.printf("pointer back to int: %d\n", zero);
}

cast_pointer_to_pointer :: fn() {
    ptr_u8 u8* := unsafe_cast<u8*>1

    let ptr_i32 i32* = unsafe_cast<i32*>ptr_u8

    if ptr_u8 == unsafe_cast<u8*>ptr_i32 {
        io.printf("pointer_to_pointer: yes\n");
    } else {
        io.printf("pointer_to_pointer: no\n");
    }
}

deref_struct :: fn(div Div*) Div {
    div2 Div := *div
    return div2
}

main :: fn() i32 {
    num i32 := 8
    io.printf("%d\n", num)
    add_one(&num)
    io.printf("%d\n", num)
    add_one_explicit(&(num))
    io.printf("%d\n", num)
    sub_one_explicit(&num)
    io.printf("%d\n", num)
    operation_2(&(num))
    io.printf("%d\n", num)
    operation_2_explicit(&num)
    io.printf("%d\n", num)

    div Div := {.numerator = 87, .denominator = 123};
    io.printf("part 67: %d/%d\n", div.numerator, div.denominator)
    set_div(&div);
    io.printf("%d/%d\n", div.numerator, div.denominator)
    set_div_denominator_explicit_deref(&div);
    io.printf("part 89: %d/%d\n", div.numerator, div.denominator)
    set_div_denominator(&div);
    io.printf("%d/%d\n", div.numerator, div.denominator)
    print_div(&div);
    div2 Div := {.numerator = 93, .denominator = 71};
    set_div_from_another(&div2, &div);
    io.printf("%d/%d\n", div2.numerator, div2.denominator)
    // ensure original div was not modified by `set_div_from_another`
    io.printf("%d/%d\n", div.numerator, div.denominator)

    string u8* := "hello"
    io.printf("%s\n", string)
    set_string(&string)
    io.printf("%s\n", string)

    cast_to_pointer()
    cast_pointer_to_pointer()

    io.printf("%d/%d\n", deref_struct(&div2).numerator, deref_struct(&div2).denominator)

    return 0
}
